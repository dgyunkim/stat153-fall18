---
title: STAT 153 Homework 3
author: Donggyun Kim
date: 12/17/2018
output: pdf_document
---

**Computer exercise:**  
$\newline$
1. **Simulation of ARMA Processes and Difference Equations**  

Let $Z_t$ be Gaussian white noise with mean 0 and variance 1. Let $C_t$ be i.i.d. Cauchy white noise with location 0 and scale 1.  

(a) For times $t \in [1, 100]$, simulate the ARMA(2,2) process $X_t = 0.7X_{t-1} - 0.3X_{t-2} + Z_t + 4Z_{t-2}$ and plot both the process and its sample ACF using the follow steps:  

- (i) Generate observations $Z_1, \dots, Z_{100}$, where $Z_i \overset{i.i.d.}{\sim} N(0, 1)$.   
- (ii) Set $X_1 = X_2 = 0$.  
- (iii) For $3 \le t \le 100$, define $X_t$ recursively using the ARMA parametrization.  
- (iv) Plot the process and its sample ACF.  

```{r}
set.seed(510)
Z <- rnorm(n = 100)
X <- rep(0, 100)
for (i in 3:length(X)){
  X[i] <- 0.7 * X[i-1] - 0.3 * X[i-2] + Z[i] + 4 * Z[i-2]
}
plot(X, type = "l", las = 1, main = "ARMA(2,2) with Gaussian Noise")
acf(X, las = 1, main = "Correlogram")
```

(b) For times $t \in [1, 100]$, simulate the ARMA(2,2) process $X_t = 0.7X_{t-1} - 0.3X_{t-2} + C_t + 4C_{t-2}$ and plot both the process and its sample ACF using the follow steps:  

- (i) Generate observations $C_1, \dots, C_{100}$, where $C_i \overset{i.i.d.}{\sim} Cauchy(0, 1)$.   
- (ii) Set $X_1 = X_2 = 0$.  
- (iii) For $3 \le t \le 100$, define $X_t$ recursively using the ARMA parametrization.  
- (iv) Plot the process and its sample ACF.  

```{r}
set.seed(510)
C <- rcauchy(n = 100)
Y <- rep(0, 100)
for (i in 3:length(Y)){
  Y[i] <- 0.7 * Y[i-1] - 0.3 * Y[i-2] + C[i] + 4 * C[i-2]
}
plot(Y, type = "l", las = 1, main = "ARMA(2,2) with Cauchy Noise")
acf(Y, las = 1, main = "Correlogram")
```

(c) Compare the two processes and their sample ACF plots, and comment on their similarities/differences.  
$\newline$
ARMA(2,2) with Caushy noise has much larger scale of value than Gaussian noise.  Autocorrelations of ARMA(2,2) with Gaussian noise are inside the blue band after lag 2, but some of them of ARMA(2,2) with Caushy noise are not.  
$\newline$
(d) **For process (a) only:** Plot the theoretical ACF for lags $1 \le h \le 20$ using the function `ARMAacf`, and also plot its asymptotic 95% confidence bands using Bartlett’s formula (you can approximate the variances in Bartlett’s formula by just summing up the first 20 terms - use R to save time). Then, plot its sample ACF again for lags $1 \le h \le 20$. Compare the two, and comment on their differences.  

```{r}
X_acf <- ARMAacf(ar = c(0.7, -0.3), ma = c(0, 4), lag.max = 20)
X_acf[2:21]
# bounds of Bartlett's formula
W <- 1 + sum(X_acf[2:21]^2)
upper <- X_acf[2:21] + 1.96 * sqrt(W / 100)
lower <- X_acf[2:21] - 1.96 * sqrt(W / 100)
# correlogram
acf(X, ylim = c(-1.0, 1.0), main = "Correlogram")
points(X_acf[2:21], type = "o", col = "green")
lines(upper, lty = 2, col = "red")
lines(lower, lty = 2, col = "red")
legend("topright", 
       legend = c("Sample ACF", "Theoretical ACF", 
                  "White Noise", "Bartlett's Formula"),
       lty = c(1, 1, 2, 2), col = c("black", "green", "blue", "red"))
```

The red band is a bit wider than the blue band. It also moves downward when the lag increases from 1 to 4, and goes upward at lag 5 and 6. After lag 6, it stays constant.  
$\newline$
(e) **For process (a) only:** To get a more accurate simulation, we should try to sample $X_1$ and $X_2$ from their actual distributions. Use the following steps to better simulate process (a) and compare to the original simulation in (a):  

- (i) Find the first 20 coefficients of the MA($\infty$) using the function `ARMAtoMA`. (This gives $\psi_1, \dots, \psi_{20}$)  
- (ii) Generate 20 new observations $Z_0, \dots, Z_{-19}$, where $Z_i \overset{i.i.d.}{\sim} N(0, 1)$.  
- (iii) Use the coefficients in Step (i) and the Gaussian observations from both Step (ii) and (a) to calculate both $X_1$ and $X_2$.  
- (iv) Follow Step (iii)-(iv) as above in (a) to finish the simulation, using the Gaussian observations generated in Step 2 and part (a).  
- (v) Compare the plots/sample ACF of this new simulation with those in (a), and comment.  

```{r}
psi <- ARMAtoMA(ar = c(0.7, -0.3), ma = c(0, 4), lag.max = 20)
set.seed(510)
Z_past <- rnorm(n = 20)
names(Z_past) <- 0:-19
X_new <- rep(0, 100)
X_new[1] <- Z[1] + sum(psi * Z_past)
Z_past <- c(Z[1], Z_past[-20])
X_new[2] <- Z[2] + sum(psi * Z_past)
for (i in 3:length(X_new)){
  X_new[i] <- 0.7 * X_new[i-1] - 0.3 * X_new[i-2] + Z[i] + 4 * Z[i-2]
}
plot(X_new, type = "l", las = 1, main = "ARMA(2,2) with Gaussian Noise")
acf(X_new, las = 1, main = "Correlogram")
```

There is no big difference between new and original process.  
$\newline$
(f) **For process (a) only:** Use the difference equations method in lecture, calculate $\gamma(h)$ for $0 \le h \le 20$ (use R for part of this to save time).  
$\newline$
$Cov(\phi(B)X_t, X_{t-h}) = \gamma_X(h) - \phi_1\gamma_X(h-1) - \phi_2\gamma_X(h-2)$  
$Cov(\theta(B)Z_t, X_{t-h}) = (\psi_0\theta_h + \psi_1\theta_{h+1} + \cdots + \psi_{q-h}\theta_q)\sigma^2$ if $h \le q$  
$Cov(\theta(B)Z_t, X_{t-h}) = 0$ if $h > q$  
$\gamma_X(0) - \phi_1\gamma_X(1) - \phi_2\gamma_X(2) = (\psi_0\theta_0 + \psi_1\theta_{1} + \psi_{2}\theta_2)\sigma_Z^2$  
$\gamma_X(1) - \phi_1\gamma_X(0) - \phi_2\gamma_X(1) = (\psi_0\theta_1 + \psi_1\theta_{2})\sigma_Z^2$  
$\gamma_X(2) - \phi_1\gamma_X(1) - \phi_2\gamma_X(0) = (\psi_0\theta_2)\sigma_Z^2$  
```{r}
psi_new <- c(1, psi[1:2])
theta <- c(1, 0, 4)
sigma2 <- 1
first <- sum(psi_new * theta) * sigma2
second <- sum(psi_new[1:2] * theta[-1]) * sigma2
third <- psi_new[1] * theta[3] * sigma2
```
$\gamma_X(0) - 0.7 \gamma_X(1) + 0.3 \gamma_X(2) = `r first`$  
$- 0.7 \gamma_X(0) + 1.3 \gamma_X(1) = `r second`$  
$0.3 \gamma_X(0) - 0.7 \gamma_X(1) + \gamma_X(2) = `r third`$  
```{r}
# solve linear system with matrix
mat <- matrix(c(1, -0.7, 0.3, 17.76, -0.7, 1.3, 0, 2.8, 0.3, -0.7, 1, 4),
              nrow = 3, byrow = TRUE)
mat
for (i in 2:3) {
  for (j in 1:(i-1)) {
    mat[i, ] <- mat[i, ] - mat[i, j] * mat[j, ]
  }
  mat[i, ] <- mat[i, ] / mat[i, i]
}
for (i in 2:1) {
  for (j in 3:(i+1)) {
    mat[i, ] <- mat[i, ] - mat[i, j] * mat[j, ]
  }
}
mat
gamma_X <- mat[, 4]
```
$\gamma_X(h) = \phi_1\gamma_X(h-1) + \phi_2\gamma_X(h-2)$ for $h > 2$  
```{r}
for (t in 4:21) {
  gamma_X[t] <- 0.7 * gamma_X[t-1] - 0.3 * gamma_X[t-2]
}
names(gamma_X) <- paste("Lag", 0:20)
gamma_X
```

(g) **For process (a) only:** From (f), calculate $\rho(h)$ for lags $1 \le h \le 20$. Plot these values and the `ARMAacf` values together in the same plot. Also, plot the error in a separate plot. Comment on both.  

```{r, fig.height=4}
rho_X <- gamma_X / gamma_X[1]
rho_X
error <- rho_X - X_acf
plot(x = 0:20, y = rho_X, type = "h", xlab = "Lag", ylab = "ACF")
points(x = 0:20, X_acf, type = "o", col = "red", lwd = 2, lty = 2)
abline(h = 0)
plot(x = 0:20, y = error, xlab = "Lag", ylab = "Error",
     main = "Error Plot")
```

```{r}
equal <- function(a, b, tol = 10^(-10)) {
  if (sum(abs(a - b)) <= tol) {
    TRUE
  } else {
    FALSE
  }
}
# are they equal?
equal(X_acf, rho_X)
```


**Theoretical exercise:**  
$\newline$
2. **Causality and Bartlett's Formula**  
Let $Z_t$ be a white noise process with variacne $\sigma^2$. Consider the ARMA process $X_t$:  
$$X_t = \frac14 X_{t-2} + Z_t + \frac12 Z_{t-1} + Z_{t-2} + \frac12 Z_{t-3}$$  
(a) Write $X_t$ in its simplest polynomial form, removing any possible common factors.  
$\newline$
$\phi(z) = 1 - \frac14z^2 = (1-\frac12z)(1+\frac12z)$  
$\theta(z) = 1 + \frac12z + z^2 + \frac12 z^3 = (1+\frac12z)(1 + z^2)$  
$(1-\frac12B)X_t = (1+B^2)Z_t$  
$\newline$
(b) Show that $X_t$ is causal, and give the MA($\infty$) representation.  
$\newline$
$\phi(z) = 1 - \frac12 z = 0 \implies z = 2 > 1$  
$\phi(z)\psi(z) = \theta(z)$  
$(1-\frac{1}{2}z)(1 + \psi_1z + \psi_2z^2 + \cdots) = 1+z^2$  
$\psi_1 = \frac12, \hspace{1mm} \psi_2 = \frac54, \hspace{1mm} \psi_3 = \frac58, \cdots$  
$\psi_k = \frac{5}{4}(\frac12)^{k-2}$ for $k \ge 2$  
$X_t = Z_t + \frac12Z_{t-1} + \sum_{j=2}^\infty(\frac54)(\frac12)^{j-2}Z_{t-j}$  
$\newline$
(c) Calculate the covariance function $\gamma(h) = Cov(X_t, X_{t+h})$.  
$\newline$
$\gamma(h) = Cov(X_t, X_{t+h}) = Cov(Z_t + \frac12Z_{t-1} + \sum_{j=2}^\infty(\frac54)(\frac12)^{j-2}Z_{t-j}, Z_{t+h} + \frac12Z_{t+h-1} + \sum_{k=2}^\infty(\frac54)(\frac12)^{k-2}Z_{t+h-k})$  
$\newline$
(d) A simulation in R for n = 100 datapoints of $X_t$ gave the following sample ACF plot. Explain why $\hat{r_1}$ exceeds the blue band so much.  
$\newline$
Using the formula from (c),  
$\rho(0) = 0.65$. The blue band represents bounds for 95% confidence interval of white noise, $\pm1.96\sqrt{\frac{1}{n}} = \pm0.196$.  

$\newline$
3. **Bartlett's Formula for White Noise and MA Processes**  
(a) Assuming its conditions are met, show that for an ARMA(p,q) process $X_t$ with p = q = 0 (ie. $X_t$ is white noise) Bartlett's formula gives the following result:  
$$\sqrt{n}\left( \begin{array}{c} \hat{r_1} \\ \hat{r_2} \\ \vdots \\ \hat{r_k} \end{array} \right) \overset{d}{\to} N_k(0, I_k)$$  
$\newline$
$W_{ij} = \sum_{m=1}^\infty[\rho(m+i) + \rho(m-i) - 2\rho(m)\rho(i)][\rho(m+j) + \rho(m-j) - 2\rho(m)\rho(j)]$  
For white noise,  
$\rho(0) = 1, \hspace{1mm} \rho(h) = 0$ for $|h| \ge 1$.  
$W_{ij} = \left\{ \begin{array}{cc} 1 & \text{if } i = j \\ 0 & \text{if } i \ne j \end{array} \right.$  
$\newline$
(b) For the MA(2) process $X_t = Z_t + \frac12 Z_{t-1} + 2Z_{t-2}$, calculate the asymptotic variance of $\sqrt{n} \hat{r_k}$ for $k \ge 3$.  
$\newline$
For MA(2),  
$\gamma(0) = \frac{21}{4}\sigma_Z^2, \hspace{1mm} \gamma(1) = \frac32\sigma_Z^2, \hspace{1mm} \gamma(2) = 2\sigma_Z^2$  
$\rho(0) = 1, \hspace{1mm} \rho(1) = \frac49 = \rho(2)$  
$\rho(h) = 0$ for $h \ge 3$  

For $k \ge 3$,  
$W_{kk} = \sum_{m=1}^\infty[\rho(m+k) + \rho(m-k) - 2\rho(m)\rho(k)]^2 = \sum_{m=1}^\infty [\rho(m-k)]^2 = 1 + 2\sum_{h=1}^2\rho^2(h) = 1 + 2[(\frac{6}{21})^2 + (\frac8{21})^2]$  


